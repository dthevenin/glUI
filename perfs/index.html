<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>GUI Component Tests</title>

    <link rel="stylesheet" type="text/css" href="index.css">

    <script type="text/javascript" src="../lib/require.js"></script>
    
    <script>
      var results = [];
      require.config ({
        paths: {
          "core": "../lib/core",
          "recognizers": "../lib/recognizers",
          "widgets": "../lib/widgets",
          "class": "../lib/class",
          "util": "../lib/util"          
        }
      });
      
      window.GL_INIT_MANUAL = true;

      window.tests = [
      {path: 'ThingsList', text:'Different kind of animations', result: 0},
      {path: '900Animations', text:'900 objects animated at same time', result: 0}
      ];

      window.index = -1;
      
      function generateCSVFile (results) {
        var text = "";
        
        results.forEach (function (data) {
          text += data.name + '\n';
          text += "functions;nb cycle;Total (ms);Average per cycle (ms);Pourcentage (%)\n";
          var result = data.result, line;
          for (var test_name in result) {
            line = result [test_name];
            text += test_name + ';';
            for (var key in line) {
              text += line[key] + ';';
            }
            text += '\n';
          }
          text += "\n\n";
        })
        
        console.groupCollapsed ("CSV output:");
        console.log (text);
        console.groupEnd ();
      }
    
      function testResult () {
        test_view.innerHTML = '';

        var text = '<span class="result">';
        var result = 0;
        for (var i = 0 ; i < tests.length; i++) {
          result += window.tests [i].result;
        }
        text += "Result: " + result + "/" + (tests.length * 5);

        text += '</span>';

        text_view.innerHTML = text;
        
        generateCSVFile (results);
      };
      
      function normalTest (index) {
        var test = window.tests [index];
        require (['core', test.path], function (core, launchTest) {
          
          var app = launchTest ();
          
          function cleanObjects () {
            for (var key in core.Object._obs) {
              var obj = core.Object._obs [key];
              obj.destructor ();
            }
          }
          
          console.group ("Profiling '" + test.path + "' normal mode.");
          core.profile.setContinousRepainting (false);
          core.profile.setContinousRedrawing (false);
          core.profile.setCollectProfile (true);
          app.startPerf (function () {
            var data = core.profile.setCollectProfile (false);
            console.groupEnd();
            results.push ({
              name: test.path,
              result: data
            })
            cleanObjects ();
            testWithForcedRedraw (index);
          });
        
        });
        
        text_view.innerHTML = '<span class="message">NORMAL TEST:' + test.text + '</span>';
      }

      function testWithForcedRedraw (index) {

        var test = window.tests [index];
        require (['core', test.path], function (core, launchTest) {
          
          var app = launchTest ();
          
          function cleanObjects () {
            for (var key in core.Object._obs) {
              var obj = core.Object._obs [key];
              obj.destructor ();
            }
          }
          
          console.group ("Profiling '" + test.path + "' redraw forced.");
          core.profile.setContinousRepainting (false);
          core.profile.setContinousRedrawing (true);
          core.profile.setCollectProfile (true);
          app.startPerf (function () {
            var data = core.profile.setCollectProfile (false);
            console.groupEnd();
            results.push ({
              name: test.path + "_REDRAW",
              result: data
            })
            cleanObjects ();
            testWithForcedRepaintAndRedraw (index);
          });
        
        });
        
        text_view.innerHTML = '<span class="message">REDRAW FORCED:' + test.text + '</span>';
      }

      function testWithForcedRepaintAndRedraw (index) {

        var test = window.tests [index];
        require (['core', test.path], function (core, launchTest) {
          
          var app = launchTest ();
          
          function cleanObjects () {
            for (var key in core.Object._obs) {
              var obj = core.Object._obs [key];
              obj.destructor ();
            }
          }
          
          console.group ("Profiling '" + test.path + "' redraw and repaint forced.");
          core.profile.setContinousRepainting (true);
          core.profile.setContinousRedrawing (true);
          core.profile.setCollectProfile (true);
          app.startPerf (function () {
            var data = core.profile.setCollectProfile (false);
            console.groupEnd();
            results.push ({
              name: test.path + "_REDRAW_REPAINT",
              result: data
            })
            cleanObjects ();
            nextTest ();
          });
        
        });
        
        text_view.innerHTML = '<span class="message">REDRAW & REPAINT FORCED:' + test.text + '</span>';
      }


      function nextTest () {
        if (index === tests.length -1) {
          testResult ();
          return;
        }
        normalTest (++index);
      }

    </script>

  </head>
  <body>
    <div class="perfPanel">
      <div id="test_view"></div>
      <div id="text_view"></div>
    <div>
    <script>
      require (['core'], function (core) {
      
        window.test_view = document.getElementById ('test_view');
        window.result_view = document.querySelector ('#result_view img');
        window.text_view = document.getElementById ('text_view');
        
        window.gl_init (
          test_view,
          test_view.offsetWidth - 6,
          test_view.offsetHeight - 6
        );
       
        window.core = core
        nextTest ();
        loadProfiling ();
      });
    </script>
  </body>
</html>
